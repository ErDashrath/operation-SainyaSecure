{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto p-4">
    <div class="hero bg-gradient-to-r from-info to-success text-white py-8 rounded-lg mb-6">
        <div class="hero-content text-center">
            <div class="max-w-md">
                <h1 class="mb-5 text-4xl font-bold">üì± Device Management</h1>
                <p class="mb-5">Military Communication Device Control Center</p>
                <div class="stats stats-horizontal bg-base-200 text-base-content rounded-lg">
                    <div class="stat">
                        <div class="stat-title">Total Devices</div>
                        <div class="stat-value">{{ total_devices }}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Online</div>
                        <div class="stat-value text-success">{{ online_count }}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Authenticated</div>
                        <div class="stat-value text-info">{{ auth_count }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card bg-base-200 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">‚ö° Quick Actions</h2>
            <div class="flex flex-wrap gap-4">
                <button class="btn btn-primary" onclick="addNewDevice()">‚ûï Add Device</button>
                <button class="btn btn-secondary" onclick="bulkAuthenticate()">üîê Bulk Authenticate</button>
                <button class="btn btn-warning" onclick="emergencyLockdown()">üö® Emergency Lockdown</button>
                <button class="btn btn-info" onclick="refreshDevices()">üîÑ Refresh Status</button>
                <button class="btn btn-accent" onclick="exportDeviceList()">üìä Export List</button>
            </div>
        </div>
    </div>

    <!-- Device Status Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Device List -->
        <div class="card bg-base-200 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">üèõÔ∏è Device Fleet Status</h2>
                <div class="overflow-x-auto max-h-96">
                    <table class="table table-compact w-full">
                        <thead>
                            <tr>
                                <th>Device ID</th>
                                <th>Owner</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Auth Level</th>
                                <th>Team</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in devices %}
                                                    <tr class="device-row hover:bg-base-300 transition-colors duration-200" data-device-id="{{ device.device_id }}">
                                <td class="font-mono text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div class="avatar">
                                            <div class="mask mask-squircle w-8 h-8 {% if device.device_type == 'base' %}bg-accent{% else %}bg-primary{% endif %}">
                                                <span class="text-xs">
                                                    {% if device.device_type == 'mobile' %}üì±
                                                    {% elif device.device_type == 'base' %}üèõÔ∏è
                                                    {% else %}üì°{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="font-bold">{{ device.device_id }}</div>
                                            <div class="text-xs text-gray-500">{{ device.device_name }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex items-center space-x-2">
                                        <div class="avatar">
                                            <div class="mask mask-squircle w-6 h-6 bg-neutral">
                                                <span class="text-xs">üë§</span>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-sm">{{ device.username }}</div>
                                            <div class="text-xs text-gray-500">{{ device.email|truncatechars:20 }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="badge {% if device.device_type == 'base' %}badge-accent{% else %}badge-outline{% endif %}">
                                        {{ device.device_type|title }}
                                    </div>
                                </td>
                                <td>
                                    {% if device.is_online %}
                                        <div class="flex flex-col space-y-1">
                                            <div class="badge badge-success">üü¢ Online</div>
                                            {% if device.is_authenticated %}
                                                <div class="badge badge-info badge-sm">üîê Authenticated</div>
                                            {% else %}
                                                <div class="badge badge-warning badge-sm">‚è≥ Pending Auth</div>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <div class="flex flex-col space-y-1">
                                            <div class="badge badge-error">üî¥ Offline</div>
                                            <div class="badge badge-outline badge-sm">{{ device.auth_status }}</div>
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="tooltip" data-tip="Security Clearance {{ device.auth_level }}">
                                        <div class="badge {% if device.clearance_level >= 5 %}badge-error{% elif device.clearance_level >= 4 %}badge-warning{% elif device.clearance_level >= 3 %}badge-info{% else %}badge-success{% endif %}">
                                            {% if device.clearance_level >= 5 %}üîí TOP SECRET{% elif device.clearance_level >= 4 %}üîê CLASSIFIED{% elif device.clearance_level >= 3 %}üîì RESTRICTED{% elif device.clearance_level >= 2 %}üìÑ CONFIDENTIAL{% else %}üìù UNCLASSIFIED{% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="badge {% if device.team == 'Alpha Team' %}badge-error{% elif device.team == 'Bravo Team' %}badge-info{% else %}badge-accent{% endif %} badge-sm">
                                        {% if device.team == 'Alpha Team' %}üî¥ Alpha
                                        {% elif device.team == 'Bravo Team' %}üîµ Bravo
                                        {% else %}üü° Command{% endif %}
                                    </div>
                                </td>
                                    </div>
                                </td>
                                <td>
                                    <div class="flex space-x-1">
                                        <button class="btn btn-xs btn-info" onclick="manageDevice('{{ device.device_id }}')">Manage</button>
                                        {% if device.is_online %}
                                            <button class="btn btn-xs btn-warning" onclick="disconnectDevice('{{ device.device_id }}')">Disconnect</button>
                                        {% else %}
                                            <button class="btn btn-xs btn-success" onclick="connectDevice('{{ device.device_id }}')">Connect</button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-gray-500">No devices registered</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Team Assignment -->
        <div class="card bg-base-200 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">üë• Team Assignment</h2>
                <div class="space-y-4">
                    <div class="collapse collapse-arrow bg-base-300">
                        <input type="radio" name="team-accordion" checked="checked" />
                        <div class="collapse-title text-xl font-medium">
                            üî¥ Alpha Team ({{ device_counts.alpha }} devices)
                        </div>
                        <div class="collapse-content">
                            <div class="space-y-2">
                                {% for device in teams.Alpha_Team %}
                                <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                                    <div class="flex items-center space-x-3">
                                        <span class="font-mono text-sm">{{ device.device_id }}</span>
                                        <span class="text-xs text-gray-500">{{ device.username }}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="badge {% if device.clearance_level >= 4 %}badge-error{% elif device.clearance_level >= 3 %}badge-warning{% else %}badge-info{% endif %} badge-sm">
                                            L{{ device.clearance_level }}
                                        </div>
                                        <div class="badge {% if device.is_online %}badge-success{% else %}badge-error{% endif %} badge-sm">
                                            {{ device.status }}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center text-gray-500 py-4">No devices assigned to Alpha Team</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="collapse collapse-arrow bg-base-300">
                        <input type="radio" name="team-accordion" />
                        <div class="collapse-title text-xl font-medium">
                            üîµ Bravo Team ({{ device_counts.bravo }} devices)
                        </div>
                        <div class="collapse-content">
                            <div class="space-y-2">
                                {% for device in teams.Bravo_Team %}
                                <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                                    <div class="flex items-center space-x-3">
                                        <span class="font-mono text-sm">{{ device.device_id }}</span>
                                        <span class="text-xs text-gray-500">{{ device.username }}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="badge {% if device.clearance_level >= 4 %}badge-error{% elif device.clearance_level >= 3 %}badge-warning{% else %}badge-info{% endif %} badge-sm">
                                            L{{ device.clearance_level }}
                                        </div>
                                        <div class="badge {% if device.is_online %}badge-success{% else %}badge-error{% endif %} badge-sm">
                                            {{ device.status }}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center text-gray-500 py-4">No devices assigned to Bravo Team</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="collapse collapse-arrow bg-base-300">
                        <input type="radio" name="team-accordion" />
                        <div class="collapse-title text-xl font-medium">
                            üü° Command Team ({{ device_counts.command }} devices)
                        </div>
                        <div class="collapse-content">
                            <div class="space-y-2">
                                {% for device in teams.Command_Team %}
                                <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                                    <div class="flex items-center space-x-3">
                                        <span class="font-mono text-sm">{{ device.device_id }}</span>
                                        <span class="text-xs text-gray-500">{{ device.username }}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="badge {% if device.clearance_level >= 4 %}badge-error{% elif device.clearance_level >= 3 %}badge-warning{% else %}badge-info{% endif %} badge-sm">
                                            L{{ device.clearance_level }}
                                        </div>
                                        <div class="badge {% if device.is_online %}badge-success{% else %}badge-error{% endif %} badge-sm">
                                            {{ device.status }}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center text-gray-500 py-4">No devices assigned to Command Team</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                            üîµ Bravo Team ({{ devices|length }} devices)
                        </div>
                        <div class="collapse-content">
                            <div class="space-y-2">
                                {% for device in devices|slice:"3:" %}
                                <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                                    <span class="font-mono text-sm">{{ device.device_id }}</span>
                                    <div class="badge {% if device.is_online %}badge-success{% else %}badge-error{% endif %}">
                                        {{ device.status }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="collapse collapse-arrow bg-base-300">
                        <input type="radio" name="team-accordion" />
                        <div class="collapse-title text-xl font-medium">
                            üü° Command Team (1 device)
                        </div>
                        <div class="collapse-content">
                            <div class="space-y-2">
                                <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                                    <span class="font-mono text-sm">COMMAND_BASE</span>
                                    <div class="badge badge-error">Offline</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Controls -->
    <div class="card bg-base-200 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">‚öôÔ∏è System Controls</h2>
            <div class="flex flex-wrap gap-4">
                <button class="btn btn-primary" onclick="pingAllDevices()">üì° Ping All Devices</button>
                <button class="btn btn-secondary" onclick="syncAllDevices()">üîÑ Sync All</button>
                <button class="btn btn-warning" onclick="revokeAllAuth()">üîí Revoke All Auth</button>
                <button class="btn btn-error" onclick="emergencyShutdown()">üö® Emergency Shutdown</button>
                <a href="{% url 'dashboard:home' %}" class="btn btn-outline">‚Üê Back to Dashboard</a>
            </div>
        </div>
    </div>
</div>

<script>
// Real-time device management functions
function manageDevice(deviceId) {
    const modal = `
        <div class="modal-box">
            <h3 class="font-bold text-lg">üîß Device Management: ${deviceId}</h3>
            <div class="py-4">
                <div class="grid grid-cols-2 gap-4">
                    <button class="btn btn-primary btn-sm">üîç View Logs</button>
                    <button class="btn btn-info btn-sm">üìä Diagnostics</button>
                    <button class="btn btn-warning btn-sm">‚öôÔ∏è Configure</button>
                    <button class="btn btn-secondary btn-sm">üîê Auth Level</button>
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold">Recent Activity:</h4>
                    <div class="text-sm text-gray-600">
                        ‚Ä¢ Last seen: Just now<br>
                        ‚Ä¢ Messages sent: 15<br>
                        ‚Ä¢ Blockchain entries: 3<br>
                        ‚Ä¢ Auth status: Verified
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    `;
    showModal(modal);
}

function connectDevice(deviceId) {
    updateDeviceStatus(deviceId, 'connecting');
    setTimeout(() => {
        updateDeviceStatus(deviceId, 'online');
        showAlert(`‚úÖ DEVICE CONNECTED\n\nDevice ${deviceId} is now online and ready for operations.`, 'success');
        updateDeviceStats();
    }, 2000);
}

function disconnectDevice(deviceId) {
    updateDeviceStatus(deviceId, 'disconnecting');
    setTimeout(() => {
        updateDeviceStatus(deviceId, 'offline');
        showAlert(`‚ö†Ô∏è DEVICE DISCONNECTED\n\nDevice ${deviceId} has been safely disconnected.`, 'warning');
        updateDeviceStats();
    }, 1500);
}

function updateDeviceStatus(deviceId, status) {
    const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
    if (row) {
        const statusCell = row.cells[3]; // Status column
        let badgeClass = 'badge-info';
        let statusText = status;
        
        switch(status) {
            case 'online':
                badgeClass = 'badge-success';
                statusText = 'üü¢ Online';
                row.className = row.className.replace('bg-red-900', 'bg-green-900');
                break;
            case 'offline':
                badgeClass = 'badge-error';
                statusText = 'üî¥ Offline';
                row.className = row.className.replace('bg-green-900', 'bg-red-900');
                break;
            case 'connecting':
                badgeClass = 'badge-warning';
                statusText = 'üîÑ Connecting...';
                break;
            case 'disconnecting':
                badgeClass = 'badge-warning';
                statusText = '‚è≥ Disconnecting...';
                break;
        }
        
        statusCell.innerHTML = `
            <div class="flex flex-col space-y-1">
                <div class="badge ${badgeClass}">${statusText}</div>
                <div class="badge badge-info badge-sm">üîê Authenticated</div>
            </div>
        `;
    }
}

function updateDeviceStats() {
    fetch('/users/api/device-status/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update header statistics
            const stats = data.statistics;
            updateStatValue('.stat-value', 0, stats.total_devices);
            updateStatValue('.stat-value.text-success', 0, stats.online_count);
            updateStatValue('.stat-value.text-info', 0, stats.authenticated_count);
            
            console.log('Device stats updated:', stats);
        }
    })
    .catch(error => console.error('Failed to update device stats:', error));
}

function updateStatValue(selector, index, value) {
    const elements = document.querySelectorAll(selector);
    if (elements[index]) {
        elements[index].textContent = value;
    }
}

// Enhanced action functions
function addNewDevice() {
    const modal = `
        <div class="modal-box">
            <h3 class="font-bold text-lg">‚ûï Add New Device</h3>
            <form id="add-device-form" class="py-4">
                <div class="form-control w-full mb-4">
                    <label class="label"><span class="label-text">Device ID</span></label>
                    <input type="text" name="device_id" placeholder="device_xxx" class="input input-bordered" required>
                </div>
                <div class="form-control w-full mb-4">
                    <label class="label"><span class="label-text">Device Type</span></label>
                    <select name="device_type" class="select select-bordered" required>
                        <option value="mobile">üì± Mobile Device</option>
                        <option value="base">üèõÔ∏è Base Station</option>
                        <option value="command">üì° Command Center</option>
                    </select>
                </div>
                <div class="form-control w-full mb-4">
                    <label class="label"><span class="label-text">Assign to User</span></label>
                    <select name="user_id" class="select select-bordered">
                        <option value="">Select User</option>
                        {% for user in users %}
                        <option value="{{ user.id }}">{{ user.username }} ({{ user.email }})</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
            <div class="modal-action">
                <button class="btn btn-primary" onclick="submitNewDevice()">Add Device</button>
                <button class="btn" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    `;
    showModal(modal);
}

function submitNewDevice() {
    const form = document.getElementById('add-device-form');
    const formData = new FormData(form);
    
    fetch('/users/api/register-device/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`‚úÖ DEVICE ADDED\n\nDevice ${data.device_id} has been successfully registered.`, 'success');
            closeModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(`‚ùå FAILED TO ADD DEVICE\n\nError: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showAlert(`üö® CONNECTION ERROR\n\nFailed to add device: ${error.message}`, 'error');
    });
}

function bulkAuthenticate() {
    showAlert('üîê BULK AUTHENTICATION INITIATED\n\n‚ö° Authenticating all pending devices...\n‚úÖ All devices have been authenticated successfully!', 'success');
    updateDeviceStats();
}

function emergencyLockdown() {
    const confirm = window.confirm('üö® EMERGENCY LOCKDOWN\n\nThis will disconnect ALL devices immediately.\n\nAre you sure you want to proceed?');
    if (confirm) {
        showAlert('üö® EMERGENCY LOCKDOWN ACTIVATED\n\nüîí All devices disconnected\nüõ°Ô∏è Communication channels secured\nüìã Incident logged for review', 'error');
        // Update all device statuses to offline
        const rows = document.querySelectorAll('.device-row');
        rows.forEach(row => {
            const deviceId = row.getAttribute('data-device-id');
            if (deviceId) {
                updateDeviceStatus(deviceId, 'offline');
            }
        });
        updateDeviceStats();
    }
}

function refreshDevices() {
    showAlert('üîÑ REFRESHING DEVICE STATUS\n\nüì° Pinging all devices...\nüîç Updating authentication status...\n‚úÖ Device refresh completed!', 'info');
    updateDeviceStats();
}

function exportDeviceList() {
    showAlert('üìä EXPORTING DEVICE LIST\n\nüìÅ Generating secure device manifest...\nüîê Applying encryption...\nüíæ Export ready for download', 'info');
}

function pingAllDevices() {
    showAlert('üì° PINGING ALL DEVICES\n\nüîç Testing connectivity...\nüìä Measuring response times...\n‚úÖ All devices responding normally', 'success');
}

function syncAllDevices() {
    showAlert('üîÑ SYNCHRONIZING ALL DEVICES\n\nüì¶ Updating configurations...\nüîê Syncing security keys...\nüìã Blockchain synchronization...\n‚úÖ All devices synchronized', 'info');
}

function revokeAllAuth() {
    const confirm = window.confirm('üîí REVOKE ALL AUTHENTICATION\n\nThis will require all devices to re-authenticate.\n\nContinue?');
    if (confirm) {
        showAlert('üîí AUTHENTICATION REVOKED\n\n‚ö†Ô∏è All device authentication cleared\nüîê Devices must re-authenticate\nüìã Security event logged', 'warning');
    }
}

function emergencyShutdown() {
    const confirm = window.confirm('üö® EMERGENCY SYSTEM SHUTDOWN\n\nThis will shut down the entire communication network.\n\nAre you absolutely sure?');
    if (confirm) {
        showAlert('üö® EMERGENCY SHUTDOWN INITIATED\n\nüî¥ All systems offline\nüõ°Ô∏è Network secured\nüìû Emergency protocols activated', 'error');
    }
}

// Utility functions
function showAlert(message, type) {
    alert(message);
}

function showModal(content) {
    const modal = document.createElement('div');
    modal.className = 'modal modal-open';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="closeModal()"></div>
        ${content}
    `;
    document.body.appendChild(modal);
}

function closeModal() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => modal.remove());
}

function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateDeviceStats();
    setInterval(updateDeviceStats, 30000); // Update every 30 seconds
});
</script>

{% csrf_token %}
    alert(`Connecting device: ${deviceId}\n\nüì° Establishing secure connection...\nüîê Authenticating credentials...\n‚úÖ Device connected successfully`);
    location.reload();
}

function disconnectDevice(deviceId) {
    if (confirm(`Disconnect device ${deviceId}?`)) {
        alert(`Device ${deviceId} disconnected safely`);
        location.reload();
    }
}

function addNewDevice() {
    const deviceId = prompt("Enter new device ID:");
    if (deviceId) {
        alert(`Registering device: ${deviceId}\n\nüìù Creating device profile...\nüîë Generating security keys...\n‚úÖ Device registered successfully`);
        location.reload();
    }
}

function bulkAuthenticate() {
    alert("Bulk Authentication Process:\n\nüîê Authenticating all pending devices...\nüìã Updating security credentials...\n‚úÖ All devices authenticated");
}

function emergencyLockdown() {
    if (confirm("Initiate emergency lockdown? This will disconnect all devices.")) {
        alert("üö® EMERGENCY LOCKDOWN ACTIVATED\n\nüîí All devices disconnected\nüì° Communications suspended\n‚ö†Ô∏è Manual override required");
    }
}

function refreshDevices() {
    location.reload();
}

function exportDeviceList() {
    alert("Device list export functionality would download device data as CSV/JSON.");
}

function pingAllDevices() {
    alert("üì° Pinging all devices...\n\n‚úÖ DEMO_ALPHA: Response time 45ms\n‚úÖ DEMO_BRAVO: Response time 52ms\n‚ùå COMMAND_BASE: No response\n\n3/5 devices responded");
}

function syncAllDevices() {
    alert("üîÑ Synchronizing all devices...\n\nüìä Pushing configuration updates\nüîê Syncing security credentials\n‚úÖ All devices synchronized");
}

function revokeAllAuth() {
    if (confirm("Revoke authentication for all devices?")) {
        alert("üîí All device authentication revoked\n\nDevices must re-authenticate to access system");
    }
}

function emergencyShutdown() {
    if (confirm("EMERGENCY SHUTDOWN - This will terminate all device connections. Continue?")) {
        alert("üö® EMERGENCY SHUTDOWN INITIATED\n\nüîå All connections terminated\nüîí System locked down\n‚ö†Ô∏è Manual restart required");
    }
}

// Auto-refresh every 30 seconds
setInterval(refreshDevices, 30000);
</script>
{% endblock %}